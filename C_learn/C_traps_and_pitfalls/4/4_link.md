## 章节

> 1. 词法“陷阱”
> 2. 语法“陷阱”
> 3. 语义“陷阱”
> 4. ***链接***
> 5. 库函数
> 6. 预处理
> 7. 可移植性
> 8. 建议
> 9. 附录

---

## 链接

第一章提到，从 C 源文件到可执行文件要经过四个步骤：预处理、编译、汇编和链接，每一个步骤都由相应的程序——预处理器、编译器、汇编器、链接器——来实现。其中，链接部分由`链接器（linker 或 link editor）`实现。

#### 4.1 什么是链接器

C 语言中的一个重要思想是`分别编译（separate compilation）`，即，若干个源文件可以在不同的时候单独编译，在恰当的时候整合在一起。（此处编译包括了预处理和汇编。具体请看《编译原理》）。

问题来了，编译器一般每次只处理一个文件，不能检测出多文件之间出现的冲突；而**在许多系统中，链接器与 C 编译器是分离的**，链接器不了解 C 语言的诸多细节。这就导致在链接部分出现的错误往往检测不到！很多文件间的错误因此而不能被发觉。

那么，单个文件内不会出现，而多个文件之间却有可能出现的错误是什么？有哪些这样的错误？实践发现，主要的、出现最多的错误是`命名冲突`。

解决办法是，在编译时留下一些信息。编译过程中除了*词法分析、语法分析和语义分析*之外，还有一个重要的步骤——`符号汇总`。汇编器根据汇总后的符号生成`符号表`。而链接器要做的就是，根据符号表来匹配文件间对应的全局变量、函数名等等，处理文件间的命名冲突。

#### 4.2 声明与定义

比较下面三条声明语句。

```C
int a;        // 1（注：声明在所有函数外）
int a = 1;    // 2
extern int a; // 3
```

语句 1 说明 a 是一个外部整型变量（或全局整型变量），同时为 a 分配了内存，初始值默认为 0；语句 2 为 a 分配内存，也说明了在该内存中存储的值；语句 3 是一个对全局变量 a 的引用声明，而不是定义，语句 3 不为 a 分配内存。

如果同一个全局变量的定义不止一次，又将如何？这个问题的答案与系统有关。严格的要求是，每个全局变量只能定义一次。

```C
int a = 1; // 定义在文件A
int a = 4; // 定义在文件B
// 大多数系统都会拒绝该程序

int b; // 定义在文件A
int b; // 定义在文件B
// 某些系统会接受

```

#### 4.3 命名冲突与 static 修饰符

`static`修饰符是一个能够减少命名冲突的有用工具。（C++ 用命名空间处理命名冲突）

如果若干个函数共享一个全局变量，可以将这些函数放到一个源文件中，再把该全局变量也放进去，用 static 修饰符声明。

如果一个函数仅仅被同一个源文件中的其他函数调用，那就应该声明该函数为 static。

#### 4.4 形参、实参与返回值

如果一个函数没有 float、short 或者 char 类型的参数，则函数声明可以省略所有参数（函数定义不能省）。但建议不要省略，可能会出现 bug。

库函数`printf`和`scanf`可以接受不同类型的参数，因此它们特别容易出错。

#### 4.5 检查外部类型

假设有一个 C 程序，它由两个源文件组成。对于下面的代码

```C
/* 文件A */
extern int n;
```

```C
/* 文件B */
long n;
```

两个语句都不在任何一个函数体内，即 n 是全局变量。这是一个有问题的程序，然而大多数 C 语言实现却检测不到。那么，当这个程序运行起来时，会发生什么情况呢？存在很多可能的情况。

1. C 编译器足够“聪明”，能够检测出这一类的类型冲突。编程人员将得到一条诊断信息。
2. C 编译器对`int`类型和`long`类型的数据在内存上的存储是一样的。尤其是在 32 位计算机上，一般都是如此处理。本来错误的程序因为某种巧合能够工作，这是一个很好的例子。
3. 变量 n 的两个语句要求的存储空间不一致，但计算机采取了`小端字节序存储`模式，即，它们共享的空间是`long`类型的低端部分。对每个`long`类型的 n 赋值，相当于把其低端部分赋给了`int`类型的 n。本来错误的程序因为某种巧合能够工作，这是一个比情况 2 更能说明问题的例子。
4. 变量 n 的两个语句要求的存储空间不一致，计算机采取的是`大端字节序存储`模式。这种情况下，程序将不能正常工作。

#### 4.6 头文件

有一个好办法可以避免大部分上述问题，那就是使用头文件。每个全局变量只在一个地方声明，即头文件。然后对所有需要用到全局变量的源文件，用一句`#include "___.h"`包含该头文件即可。注意，定义这些全局变量的源文件也应该包含这个头文件。

> ##### 练习 4_1
>
> 编写一个测试程序，检测当前机器是大端字节序存储，还是小端字节序存储。
